local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = game.Workspace.CurrentCamera

local ScreenGui = Instance.new("ScreenGui", game.Players.LocalPlayer:WaitForChild("PlayerGui"))
local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 200, 0, 100)
Frame.Position = UDim2.new(0, 10, 0, 10)
Frame.BackgroundTransparency = 0.5
Frame.BackgroundColor3 = Color3.new(0, 0, 0)

local EspButton = Instance.new("TextButton", Frame)
EspButton.Size = UDim2.new(1, 0, 0.5, 0)
EspButton.Position = UDim2.new(0, 0, 0, 0)
EspButton.Text = "Toggle ESP"
EspButton.BackgroundColor3 = Color3.new(1, 1, 1)

local AimbotButton = Instance.new("TextButton", Frame)
AimbotButton.Size = UDim2.new(1, 0, 0.5, 0)
AimbotButton.Position = UDim2.new(0, 0, 0.5, 0)
AimbotButton.Text = "Toggle Aimbot"
AimbotButton.BackgroundColor3 = Color3.new(1, 1, 1)

local espEnabled = false
local aimbotEnabled = false

EspButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    EspButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"
end)

AimbotButton.MouseButton1Click:Connect(function()
    aimbotEnabled = not aimbotEnabled
    AimbotButton.Text = aimbotEnabled and "Aimbot: ON" or "Aimbot: OFF"
end)

local function isObstructed(origin, target)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {Players.LocalPlayer.Character, origin.Parent}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.IgnoreWater = true
    local result = workspace:Raycast(origin.Position, target.Position - origin.Position, raycastParams)
    return result and result.Instance ~= nil
end

local function findClosestVisibleEnemy()
    local closestPlayer, shortestDistance = nil, math.huge
    local myPosition = Camera.CFrame.p
    local localPlayer = Players.LocalPlayer

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Team ~= localPlayer.Team and player.Character then
            local head = player.Character:FindFirstChild("Head")
            if head and not isObstructed(Camera, head) then
                local distance = (head.Position - myPosition).Magnitude
                if distance < shortestDistance then
                    closestPlayer, shortestDistance = player, distance
                end
            end
        end
    end
    return closestPlayer
end

local function createBox(player)
    local head = player.Character.Head
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Adornee = head
    billboardGui.Size = UDim2.new(4, 0, 5, 0)
    billboardGui.AlwaysOnTop = true
    billboardGui.StudsOffset = Vector3.new(0, 3, 0)

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BorderSizePixel = 2
    frame.BackgroundTransparency = 1
    frame.BorderColor3 = Color3.new(1, 0, 0)

    frame.Parent = billboardGui
    billboardGui.Parent = player.Character
end

local function removeBoxes()
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            for _, child in ipairs(player.Character:GetChildren()) do
                if child:IsA("BillboardGui") then
                    child:Destroy()
                end
            end
        end
    end
end

local function shoot()
    print("Shooting at the enemy player's head!")
end

local function update()
    removeBoxes()
    if espEnabled then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Players.LocalPlayer and player.Team ~= Players.LocalPlayer.Team and player.Character then
                local head = player.Character:FindFirstChild("Head")
                if head then
                    createBox(player)
                end
            end
        end
    end

    if aimbotEnabled then
        local closestPlayer = findClosestVisibleEnemy()
        if closestPlayer then
            local head = closestPlayer.Character.Head
            local targetPosition = head.Position
            local cameraLookVector = (targetPosition - Camera.CFrame.p).unit
            local currentLookVector = Camera.CFrame.lookVector

            if UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) and cameraLookVector:Dot(currentLookVector) > 0.99 then
                shoot()
            end
        end
    end
end

RunService.RenderStepped:Connect(update)
